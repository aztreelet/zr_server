

## server æœåŠ¡å™¨ä¸»ç¨‹åº 

ä¸»ç¨‹åºä¸­å½“ç„¶ä¼šè°ƒç”¨å¾ˆå¤šå…¶ä»–æ–‡ä»¶ä¸­çš„åŠŸèƒ½å‡½æ•°æˆ–è€…ç»“æ„ä½“å®šä¹‰ï¼Œåˆçœ‹æ­¤å·¥ç¨‹åªéœ€è¦çŸ¥é“å¯¹åº”åŠŸèƒ½å³å¯ï¼Œä¸å¿…å»æ·±è¿½ä»£ç ï¼Œå¿…è¦çš„åŠŸèƒ½ä¼šè®¾ç½®è·³è½¬é“¾æ¥ï¼›

### ç®€ä»‹

æ–‡ä»¶ï¼š`server.c server.h`ï¼›
åŠŸèƒ½ï¼šæœåŠ¡å™¨å¯åŠ¨çš„ä¸»ç¨‹åºï¼›

### æµç¨‹å›¾

![server](assets/serveræµç¨‹.png)

**Notesï¼š**

* å³ä¾§çº¿ç¨‹æ± ç›¸å…³å¤„ç†è¿‡ç¨‹åé¢åœ¨è¯¦ç»†å±•å¼€ï¼›
* ä½¿ç”¨äº†Reactoræ¨¡å‹ï¼Œå‚è€ƒæ¸¸åŒP128ï¼›

### main()

æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œä¸»è¦æä¸€ä¸‹zr_printfçš„ç”¨æ³•ï¼›ğŸ¤£

### zr_server()

æœåŠ¡å™¨åŠŸèƒ½å‡½æ•°ï¼›

æ³¨æ„å‚æ•° ip å’Œ port éƒ½æ˜¯å­—ç¬¦ä¸²ï¼›

ä»ä¸Šå¾€ä¸‹çœ‹æºç ï¼š

#### è®¾ç½®å¿½ç•¥ä¿¡å·

ç²—ç•¥è¯´ä¸€ä¸‹ï¼šåœ¨linuxä¸­ï¼Œç³»ç»Ÿå¯¹å¾ˆå¯¹å¾ˆå¤šä¿¡å·çš„é»˜è®¤å¤„ç†æ–¹å¼éƒ½æ˜¯ç»ˆæ­¢å‘å‡ºä¿¡å·çš„ç¨‹åºï¼Œç½‘ç»œæœåŠ¡å™¨å½“ç„¶ä¸èƒ½å› ä¸ºå®¢æˆ·ç«¯å…³é—­ä¿¡å·æˆ–è€…å¯¹ç«¯ç®¡é“å…³é—­ç­‰ä¿¡å·å°±è¢«ç³»ç»Ÿæ€æ­»ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®è¿™äº›ä¿¡å·çš„å¤„ç†æ–¹å¼ï¼›

##### addsig() è®¾ç½®ä¿¡å·å¤„ç†æ–¹å¼

è¯¥ç¨‹åºä¸­ä½¿ç”¨æ­¤å‡½æ•°å¿½ç•¥SIGPIPEå‡½æ•°ï¼›

```c
/* ignore the SIGPIPE */
addsig( SIGPIPE, SIG_IGN, true);
```

å‡½æ•°æºç ï¼š

```c
/* is_start default is true */
void addsig(int sig, void(handler)(int), bool is_restart)
{
    struct sigaction sa;
    memset(&sa, '\0', sizeof(sa));
    sa.sa_handler = handler;
    if (is_restart) {
        sa.sa_flags |= SA_RESTART;
    }
    /* Add all signal to mask, dont use signal`s default handle method */
    sigfillset(&sa.sa_mask);
    assert(sigaction(sig, &sa, NULL) != -1);
}
```

**Notesï¼š**

* sigactionä»¥åŠç›¸å…³å‡½æ•°ï¼Œæ˜¯ä¹¦æœ¬ä¸­çš„çŸ¥è¯†ï¼Œè‡ªè¡Œç™¾åº¦ï¼›
* `SA_RESTART`ï¼šä¿¡å·è§¦å‘æ—¶ï¼Œè¦å»è°ƒç”¨å¯¹åº”ä¿¡å·å¤„ç†å‡½æ•°ï¼Œå¯èƒ½ä¼šä¸­æ–­ä¸€äº›å…¶ä»–ç³»ç»Ÿè°ƒç”¨ï¼›å¦‚æœå¯¹æ­¤ä¿¡å·è®¾ç½®äº†SA_RESTARTï¼Œåˆ™å› æ­¤ä¿¡å·ä¸­æ–­çš„ç³»ç»Ÿè°ƒç”¨ä¼šè‡ªåŠ¨é‡å¯ï¼ˆè€Œä¸æ˜¯è¢«ä¸­æ–­æˆ–è¿”å›é”™è¯¯ï¼‰ï¼›
* `sigfillset(&sa.sa_mask);`ï¼šä½¿ç”¨ `sigfillset` å‡½æ•°å°† `sa_mask` æˆå‘˜è®¾ç½®ä¸ºä¸€ä¸ªåŒ…å«æ‰€æœ‰ä¿¡å·çš„ä¿¡å·é›†ï¼›åœ¨æ­¤sigä¿¡å·åœ¨å¤„ç†æ—¶ï¼Œ`sa_mask`ä¸­æŒ‡å®šçš„ä¿¡å·å°†è¢«é˜»å¡ï¼Œä»¥é˜²æ­¢å¹²æ‰°å¯¹sigä¿¡å·çš„å¤„ç†ï¼ˆä¾‹å¦‚é¿å…äº§ç”ŸåµŒå¥—çš„ä¿¡å·è°ƒç”¨ï¼Ÿï¼‰ï¼›
* line12ä¸­`sigaction(sig, &sa, NULL)`å°†sigä¸saç»‘å®šèµ·æ¥ï¼›



#### lingerå»¶è¿Ÿå…³é—­sockfd

ä¸ºäº†åº”å¯¹åœ¨å…³é—­å¥—æ¥å­—æ—¶æœ‰æ•°æ®æœªå‘é€å®Œæ¯•çš„æƒ…å†µï¼Œå¯ä»¥è®¾ç½®å¥—æ¥å­—å»¶è¿Ÿå…³é—­ï¼›

```c
    struct linger tmp = { 1, 0 };   //æ‰“å¼€å»¶è¿Ÿå…³é—­å¼€å…³ï¼Œä½†æ˜¯æ—¶é—´è®¾ç½®ä¸º0ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸å»¶è¿Ÿ
    setsockopt(listenfd, SOL_SOCKET, SO_LINGER, &tmp, sizeof(tmp));
```

`struct linger` ç»“æ„è¡¨ç¤ºå¥—æ¥å­—çš„å»¶è¿Ÿå…³é—­è¡Œä¸ºã€‚å®ƒå…·æœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼š

* `l_onoff`ï¼šæŒ‡å®šæ˜¯å¦å¯ç”¨å»¶è¿Ÿå…³é—­ã€‚å¦‚æœå°†å…¶è®¾ç½®ä¸ºéé›¶å€¼ï¼ˆåœ¨è¿™é‡Œæ˜¯1ï¼‰ï¼Œåˆ™å¯ç”¨å»¶è¿Ÿå…³é—­ï¼›å¦‚æœè®¾ç½®ä¸º0ï¼Œåˆ™ç¦ç”¨å»¶è¿Ÿå…³é—­ã€‚
* `l_linger`ï¼šæŒ‡å®šå»¶è¿Ÿå…³é—­çš„æ—¶é—´ã€‚å¦‚æœ `l_onoff` è¢«è®¾ç½®ä¸ºéé›¶å€¼ï¼Œé‚£ä¹ˆ `l_linger` è®¾ç½®äº†å»¶è¿Ÿå…³é—­çš„æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚

**Notesï¼š**æ­¤ç¨‹åºä¸­æ‰“å¼€äº†å»¶è¿Ÿå¼€å…³ï¼Œä½†æ˜¯æœªè®¾ç½®å»¶è¿Ÿï¼ˆä»¥åè‹¥æœ‰éœ€è¦ï¼Œå¯ä»¥è‡ªè¡Œè®¾ç½®ï¼‰ï¼›



#### ç©ºé—´æ¢æ—¶é—´æ€æƒ³åº”ç”¨

é¢„å…ˆåˆ†é…å¥½ç©ºé—´æ¥æå‡å“åº”é€Ÿåº¦ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªåœ°æ–¹ä½¿ç”¨ï¼š

##### users

```c
#define MAX_FD							65535
HTTP_CONN_t *users = (HTTP_CONN_t *)malloc(sizeof(HTTP_CONN_t) * MAX_FD); 
```

ç›´æ¥åˆ†é…äº†ç­‰åŒäºæœ€å¤§fdä¸ªæ•°çš„usersç©ºé—´ï¼Œæ¯ä¸ªuserå¯¹åº”äºä¸€ä¸ªHTTP_CONN_tç±»å‹çš„å¯¹è±¡ï¼ˆå…¶ä¸­æ˜¯åŒ…å«äº†å„è‡ªçš„è¯»å†™bufç­‰å„ç§å±æ€§ï¼‰ï¼›

åŒæ—¶ä¹Ÿå› ä¸ºæœ‰MAX_FDä¸ªï¼Œå‡è®¾æœ‰æ–°è¿æ¥ä¸”å…¶socketä¸ºconnfdï¼Œå¯ä»¥ç›´æ¥å°†å…¶å­˜å…¥users[connfd]ï¼Œä¹Ÿå°±å¯ä»¥ç›´æ¥ä½¿ç”¨users[connfd]ç´¢å¼•è¯¥è¿æ¥ï¼›

##### zr_thread_pool_create()ä¸­çº¿ç¨‹æ•°ç»„

```c
//zr_thread_pool.c
ztp->m_threads = (pthread_t *)malloc(sizeof(pthread_t) * ztp->m_thread_number);
```



#### epoll

epollçš„åŸºç¡€çŸ¥è¯†ä¸åšèµ˜è¿°ï¼Œå»ºè®®çœ‹ä¹¦ï¼ˆä¸å»ºè®®ç™¾åº¦ï¼Œå› ä¸ºç½‘ç»œçŸ¥è¯†å¾ˆç¢ç‰‡å¾ˆç¢ç‰‡åŒ–ä¸”è´¨é‡æ™®éä¸é«˜ï¼‰ã€‚

epollç¼–ç¨‹ä¸»è¦æ¡†æ¶ï¼š

```c
/***** 1.åˆ›å»ºepollå®ä¾‹ *****/
struct epoll_event events[ MAX_EVENT_NUMBER ];	/* äº‹ä»¶æ•°ç»„ï¼Œå½“äº‹ä»¶å‘ç”Ÿæ—¶ä¼šè¢«ç³»ç»Ÿæ·»åŠ åˆ°æ­¤æ•°ç»„ä¸­ */
epollfd = epoll_create(5);							/* åˆ›å»ºepollå®ä¾‹ */
assert(epollfd != 0);

/***** 2.è®¾ç½®äº‹ä»¶ *****/
/* ç»‘å®šepollfdä¸listenfdï¼Œè®¾ç½®ç›‘å¬äº‹ä»¶ */
struct epoll_event event;
event.data.fd = fd;											/* è®¾ç½®å…³è”çš„fd */
event.events = EPOLLIN | EPOLLRDHUP;		/* è®¾ç½®äº‹ä»¶ï¼ŒEPOLLRDHUPä¸ºå¯¹ç«¯æˆ–è¿æ¥å…³é—­äº‹ä»¶ */
event.events |= EPOLLET;								/* è®¾ç½®è¾¹æ²¿è§¦å‘ */
epoll_ctl(epollfd, EPOLL_CTL_ADD, fd, &event);
setnoblock(fd);													/* è®¾ç½®éé˜»å¡ */

/***** 3.ç­‰å¾…äº‹ä»¶ *****/
/* é€šå¸¸æ”¾åˆ°whileä¸­ */
while (true) {
    /* å‘ç”Ÿçš„äº‹ä»¶æ•°é‡ï¼ˆäº‹ä»¶è¢«æ·»åŠ åˆ°eventsæ•°ç»„ä¸­ï¼‰ */
    int number = epoll_wait(epollfd, events, MAX_EVENT_NUMBER, -1);
    if ((number < -1) && (errno != EINTR)) {
				//...
        break;
    }
		/***** 4.å¤„ç†å°±ç»ªçš„äº‹ä»¶ *****/
    for (int i = 0; i < number; ++i) {
        int sockfd = events[i].data.fd;
        /* å¸¸è§ä¸€äº›äº‹ä»¶ */
      	/* æœåŠ¡å™¨ç»‘å®šçš„listenfdä¸Šå‘ç”Ÿäº‹ä»¶ï¼Œè¡¨ç¤ºæœ‰æ–°è¿æ¥ */
        if (sockfd == listenfd) {
						//...æ¥æ”¶æ–°å®¢æˆ·ç«¯è¿æ¥çš„æ“ä½œ...
          	//accept()...
        }
        /* New event come but err. */
        else if ( events[i].events & (EPOLLRDHUP | EPOLLHUP | EPOLLERR) ) {
						//å‘ç”Ÿé”™è¯¯ï¼Œå…³é—­fdå¯¹åº”è¿æ¥çš„æ“ä½œ...
        }
        /* fdæœ‰å¯è¯»äº‹ä»¶ */
        else if ( events[i].events & EPOLLIN ) {
						//ä»fdè¯»å–æ•°æ®çš„æ“ä½œ
        }
        /* fdæœ‰å¯å†™äº‹ä»¶ */
        else if ( events[i].events & EPOLLOUT ) {
						//å°†æ•°æ®å†™å…¥fdçš„æ“ä½œ
        }
        else {
						//other...
        }
    }
}

/***** é™„.è‹¥è¿æ¥æ–­å¼€ï¼Œåˆ é™¤fdå¯¹åº”äº‹ä»¶ *****/
epoll_ctl(epollfd, EPOLL_CTL_DEL, fd, 0);
/***** é™„.é’ˆå¯¹æ•°æ®è¯»å†™æƒ…å†µï¼Œä¿®æ”¹äº‹ä»¶ *****/
epoll_ctl(epollfd, EPOLL_CTL_MOD, fd, &event);
```

**Notesï¼š**

* æ­¤å¤„åˆå§‹åŒ–æ—¶åªè®¾ç½®EPOLLINäº‹ä»¶è¯»å–httpè¯·æ±‚æŠ¥æ–‡ï¼›
* å½“æœ‰çº¿ç¨‹è·å–åˆ°httpæŠ¥æ–‡çš„å¤„ç†ä»»åŠ¡æ—¶ï¼Œæ‰ä¼šç»™å¯¹åº”fdè®¾ç½®EPOLLOUTæ—¶é—´ï¼Œä»¥å¾€fdä¸­å†™å…¥æ•°æ®ï¼›



### æ€»ç»“

ä»¥ä¸Šå°±æ˜¯ä¸»ç¨‹åºçš„å¤§è‡´æµç¨‹ï¼Œä¸»è¦å·¥ä½œå°±æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ç½‘ç»œç¼–ç¨‹æµç¨‹ã€åˆå§‹åŒ–æˆ–é¢„å…ˆåˆ†é…ä¸€ä¸‹ç©ºé—´ã€è®¾ç½®epollç­‰ï¼Œå…³é”®åœ¨äºå¯¹äº‹ä»¶çš„å¤„ç†ï¼Œè¯¦æƒ…å‚è€ƒhttp_connè§£ææ–‡æ¡£ï¼›
